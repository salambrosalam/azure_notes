
Azure notes

=================================

Deply and Manage compute resources



Default creating windows VM using azure gui.
B1s size is free for 750 hours per month (if free-tier period)
Windows Server prefer config: (2vcpus, 8GB RAM)

Security group is creating by default with VM (if you will not choose any security group)
Azure Virtual Network - is isolated network on the Azure Cloud

If you have some issues with limits of creating VMs, you have to create request for extension of limit (Microsoft.Compute)


IIS - web server on windows
how to install it using GUI:
>"Add features"
>in section "Server Roles" click on Web Server (IIS)
>add PORT 80 as allowed in network security group (nsg) attached to this VM 
Then just "next" and install :)

In Azure Subscription you should to create your monthly budget and budget alert (for example 80% percents of used budget)

No costs resources: Virtual Network, NSG, Network interface

State of the Virtual Machine:

Types of disks:
>OS disk (Managed Disk -Designed for high availability, all aspects of the disk will be managed by Azure themselves)
>Temporary disk - size varies depending on the instance size, data on the temporary disk is lostu during a maintenance event, data is lost when you redeploy or STOP and START the VM,
you will not LOST your data in case of RESTART VM                  

Azure have a separeted costs of a resource, even if your VM is shutdown you'll pay for disks (of this VM)                                                                                 

SSH tip: pub key is stored on VM, you will get private key for connet and auth on this VM 


Azure Disks:

>Management - You have Azure Managed Disks that are completely managed by Azure
>Virtualized - Its like having physical disks but they are virtualized
>Highly available - Designed with 99.999% availability
>Support - Has support with features such as Availability Zones, Azure Backup etc.

Disk Types:
>Standard HDD - This is ideal for backup environments and non-critical workloads. Max disk size - 32 767 GB, Max throughput - 500MB/s Max IOPS - 2000
>Standard SSD - This is ideal for Web Servers and Dev/Test Environments. Max disk size - 32 767 GB, Max throughput - 750 MB/s, Max IOPS - 6000.
>Premium SSD - This is ideal for Production environments. Max disk size - 32 767 GB, Max throughput - 950 MB/s, Max IOPS - 20 000.
>Ultra Disk - This is ideal for Input/Output instensive workloads - SQL, Oracle databases. Max disk size - 65 536 GB, Max throughput - 4000 MB/s. Max IOPS - 160 000.


Server-Side Disk Encryption:

Your data is automatically encrypted using 256-bit AES Encryption
This protects the data at rest
This is done for Managed disks - OS and data Disks

It's need to if this disk will be stolen, hackers can't get data from disk cause encryption

for example: 
Encryption: SSE (Server-Side Encryption) with PMK (Platform managed key). That means that key to decrypt this key is stored on platform.

You also have option "Customer keys for encryption":
> you can store your keys using "Azure key vault"
to make this:
>create key vault
>create key
>create disk encryption set
>encrypt disk with "disk encryption set"

Azure Disk Encryption:

os Windows (with bit locker) on Linux with DM-Crypt
Encrypt your disk volumes:
>create key in key vault
>open additional settings and enable disks to encrypt (OS and data disks), and choose current key.

IOPS - Input/Output operations per second (read and writes to data, for example from database)
Throughput - Amount of data is being sent to the storage disk at a specified interval (MB per sec)

Disk snapshot:

To make snapshot of disk on Azure:
>Create disk
>click "Create snapshot"

Snapshot it's READ-ONLY disk replica, but you can create disk based on snapshot (for exapmle, you will get data from snapshot on disk based on this snapshot)

Shared Disk:

Azure Shared Disk - This allows a managed disk to be attached to multiple virtual machine, can only enable for PREMIUM and ULTRA disks!

how to make:
>Create "Managed Disk"
>Configure VM's (this should be the same location as this share disk)
>To attach disk, you have to stop VM 

Manage and UnManaged Disks:

Managed disk - you get high availability. Because the data is replicated automatically on different places within Azure Data center.
Un-managed disk - you own disk, not managed by Azure and these disk will be stored in Azure blob's storage and then you can attach disk to the VM.

NOTE: You can't have both managed and un-managed disk with VM

Ok difference in cost. For the managed disk you will pay for all space (for example 128GB), in un-managed disk only for space wich you consumes.

The storage account disk type (premium SSD or standard SSD, HDD) should be the same like a disk for VM

how to make un-managed disk:
>create storage account
>on stage of creating VM, on "Disks" disable managed disks, and enable "Use ephemeral OS disk" and choose storage account

Un-managed disks stored in "vhds container" in storage account

Custom Script Extensions:

This tool can be used on Azure virtual Machines to download and execute scripts.
This is ideal when you want to deploy any custom configuration of any software installation on a virtual machine.
The scripts can be located in an Azure storage account or even on GitHub.
A time duration of 90 minutes is allowed for the script to run. Any longer and the result will be a failed extension provision.
It's ideal not to place reboots inside the scripts, because the extension will not continue after the reboot. Hence if have other commands that need to run via the extension after the reboot, they won't run.
If your scipt does need a reboot, then maybe you can look at other tools such as Desired State Configuration, Chef or Puppet.
The script will run only once.
The Custom Script Extension will run under the impersonation of the LocalSystem Account.

On Windows - PowerShell scripts.
On Linux - Bash scripts 

Cloud init - this is scripts like Script Extensions but in plain text way, you should not download script file and with Azure syntax
you could run Azure Scripts, example:

#cloud-config
package_upgrade: true
packages: 
	- nginx

Boot Diagnostics:

This is option to diagnostics for VM (during the time of VM)

Serial Console:

To use this option you have to use "Enable with custom storage account" in Boot diagnostics
Using serial console you could connect to VM using console

Run Command:

Useful option to run some scripts on running VM
 
Azure Bastion Service:

Azure Bastion Service - Fully managed PaaS service to connect to the VM's without public IP (throw this Bastion Host)
Provides RDP/SSH connectivity to virtual machines from the Azure Portal via TLS

Azure Bastion - must have subnet name "AzureBastionSubnet". This subnet will host Bastion compute instances
Then we should to assign public IP address to bastion.
Then to use just click "Bastion" in connection section (in VM menu)

Basic tier of Bastion host - can't change bastion compute instances
Standard tier of Bastion host - can change bastion compute instances

Availability sets:
An availability set is a logical grouping of VMs that allows Azure to understand how your application is built to provide for redundancy and availability

Using availiability sets you will get an SLA of 99.95% 

Fault domain - define the group of virtual machines that share a common power source and network switch (server rack). By default, the virtual machines configured within your availability set are separated across up to three fault domains.You can have up to 3 fault domains.
Update domain - Update domains indicate groups of virtual machines and underlying physical hardware that can be rebooted at the same time. You can have up to 20 update domains.

In 1 fault domain you can have a few update domains

Proximity placement group - store your machines closer together to get better communications, you can choose this option
ONLY when you create a virtual machine you can assign the availability set!

Availability zones:

Availibility zones - are unique physical locations that are equipped with independent power, cooling and networking.
There are normally three Availiability zones in region.

Using this we will get extra costs for bandwith

Using availiability sets you will get an SLA of 99.99% 

Using scale set, you can choose multiple availability zones

Azure Scale sets:

Scale set - this is tool to distribute the load on several machines instead of one. (for example: To scale from 1 machine to 3)
We can define the rules. The rule is based on a condition. Scale out - if the CPU percentage > 70% then add one machine, scale in - if the CPU percentage < 70 % then delete one machine
To define the scaling rule:

Open "Scaling" section in scale-set:
>enable "Custom autoscale"
>define the auto-scaling rule

There two types: 
>Uniform orchestration mode - Optimized for large scale stateless workloads with identical instances
>Flexible orchestration mode - achieve high availability at scale with identical or multiple virtual machine types

In uniform mode - you have separate API's of scale set to manage this VM's
in flexible mode - you have normal VM API's to manage VM. (resources creates like a separate VM)

VM Image:

Image - This is a copy of the full VM which includes the data disks or just the OS disk
You can create an image and place as part of an Azure compute gallery

You can share the Azure compute gallery across your organizations so that other users can create VM's based on the images stored in the gallery
Image Definition - This is a grouping of image versions. Each image definition has information about why the image was created and other information related to the image
Image Version - this is used to create the VM.
Two types of images that you can create:
>Specialized VM images. Here information about specific users and machine information is retained. So new VM's created out of the image will have the same computer name and admin user information.
>Generalized VM images. Here information about specific users and machine information is removed.  Here you have to perform the process of generalization. The original VM is unusable after you perform this process.

Generalized VM:
>on Windows you have path: C:/Windows/System32/Sysprep/  here will be app (sysprep)
>enable "Generalize" to prepare machine to Generalized Image (this app will remove all credentials, will prepapre machine and you will not have opportunity to use this VM more)


Azure Gallery - dataset of VM images, you can share gallery to others users in Azure

Resize VM:

>choose VM
>select section "Size"
>change size

Proximity Placement groups:

Normally when you create multiple virtual machines or virtual machines that are part of virtual machine scale set, these machines could be located in different data centers.
Sometimes an application/system that uses multiple virtual machines, want the virtual machines to be located closer together to get latency when it comes to communication between the virtual machines
By placing the virtual machines as part of a proximity group, the virtual machines will be physically located close to each other.
When using proximity placement groups, ensure the virtual machines have accelerated nerworking enabled. This also helps to improve network performance.
When deploying VM's from differents families or SKU's, try to deploy them as part of a single template. This will increase the probability of ensuring all VM's are deployed successfully.
A proximity placement group is assigned to a data center when the first resource (VM) is being deployed and released once the last resource is being deleted or stopped.

How to make:
>Create "Proximity Placement Group"
>choose create group in during creating VM

Azure Web App:

You don't have to maintain the underlying compute Infrastructure.
It has features such as Autoscaling and security.
It has DevOps capabilities which includes continuous deployement.

App Service planes:
>Free: max 10apps. Disk space - 1GB. Max instances - 0. Custom Domain - 0. Auto Scale - 0. Hybrid Connectivity - 0.
>Shared: max 100apps. Disk space - 1 GB. Max instances - 0. Custom Domain - Supported. Auto scale - 0. Hybrid Connectivity - 0.
>Basic: max apps - unlimited. Disk space: 10GB. Max instances - 3. Custom domain - Supported. Auto Scale - 0. Hybrid Connectivity - Supported.
>Standard: max apps - unlimited. Disk space: 50GB. Max instances - 10. Custom domain - Supported. Auto Scale - Supported. Hybrid Connectivity - Supported.
>Premium: max apps - unlimited. Disk space: 250GB. Max instances - 30. Custom domain - Supported. Auto Scale - Supported. Hybrid Connectivity - Supported.
>Isolated: max apps - unlimited. Disk space: 1 TB. Max instances - 100. Custom domain - Supported. Auto Scale - Supported. Hybrid Connectivity - Supported.

Free:

>Cores - 60 (CPU minutes / day)
>RAM - 1 GB
>Storage 1 GB
>Price: 0$ - free tier

Shared: 

>Cores - 240 (CPU minutes / day)
>RAM - 1 GB 
>Storage - 1 GB 
>Price: $0.013/hour per site

Depends on runtime stack (programming lang.) you have to choose: Linux or Win

You get a set of logging features that are available for the Azure Web App.
The different types of logging that are available are

Application Logging - This captures log messages that are generated by your application code.
Web Server Logging - This records raw HTTP request data.
Detailed Error Messages - This stores copies of the .htm error pages would have been sent to the client browser.
Deployement Logging - These are logs when you publish content to an application.
You can also stream logs in real time.

Deployment slots:

plans which supports slots: Standard, Premium and Isolated

Staging Environments for Web Apps
Applications in deployment slots have their own host names
You have the chance to validate all application changes in the staging deployment slot
You can then swap the staging slot with the production slot
This helps eliminate the downtime for your application when new changes are deployed
You can also easily roll back the changes

To upgrade plan: 
>in section "Scale up"
>change plan

Auto scaling of Web App:
>in section "Scale out"
>"custom auto scaling"

Cool down - You can also set something called a “cool down” period. This is the number of minutes to wait after a scaling operation before it can scale again. 
By default, it's set to 5 minutes. This gives the metrics a chance to stabilize again after the scaling operation. During this time the scaling process should not take into account any metrics or thresholds that get breached.
Cool down

Azure Web App VNET Integration:

Allows the App service to access resources within the VNET. But it does not allow private inbound access to your Web App from the virtual network.
use case scenario:
>to allow connect from Web App server to the DB server in your vnet



