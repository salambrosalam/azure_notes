
Azure notes

=================================

Deply and Manage compute resources



Default creating windows VM using azure gui.
B1s size is free for 750 hours per month (if free-tier period)
Windows Server prefer config: (2vcpus, 8GB RAM)

Security group is creating by default with VM (if you will not choose any security group)
Azure Virtual Network - is isolated network on the Azure Cloud

If you have some issues with limits of creating VMs, you have to create request for extension of limit (Microsoft.Compute)


IIS - web server on windows
how to install it using GUI:
>"Add features"
>in section "Server Roles" click on Web Server (IIS)
>add PORT 80 as allowed in network security group (nsg) attached to this VM 
Then just "next" and install :)

In Azure Subscription you should to create your monthly budget and budget alert (for example 80% percents of used budget)

No costs resources: Virtual Network, NSG, Network interface

State of the Virtual Machine:

Types of disks:
>OS disk (Managed Disk -Designed for high availability, all aspects of the disk will be managed by Azure themselves)
>Temporary disk - size varies depending on the instance size, data on the temporary disk is lostu during a maintenance event, data is lost when you redeploy or STOP and START the VM,
you will not LOST your data in case of RESTART VM                  

Azure have a separeted costs of a resource, even if your VM is shutdown you'll pay for disks (of this VM)                                                                                 

SSH tip: pub key is stored on VM, you will get private key for connet and auth on this VM 


Azure Disks:

>Management - You have Azure Managed Disks that are completely managed by Azure
>Virtualized - Its like having physical disks but they are virtualized
>Highly available - Designed with 99.999% availability
>Support - Has support with features such as Availability Zones, Azure Backup etc.

Disk Types:
>Standard HDD - This is ideal for backup environments and non-critical workloads. Max disk size - 32 767 GB, Max throughput - 500MB/s Max IOPS - 2000
>Standard SSD - This is ideal for Web Servers and Dev/Test Environments. Max disk size - 32 767 GB, Max throughput - 750 MB/s, Max IOPS - 6000.
>Premium SSD - This is ideal for Production environments. Max disk size - 32 767 GB, Max throughput - 950 MB/s, Max IOPS - 20 000.
>Ultra Disk - This is ideal for Input/Output instensive workloads - SQL, Oracle databases. Max disk size - 65 536 GB, Max throughput - 4000 MB/s. Max IOPS - 160 000.


Server-Side Disk Encryption:

Your data is automatically encrypted using 256-bit AES Encryption
This protects the data at rest
This is done for Managed disks - OS and data Disks

It's need to if this disk will be stolen, hackers can't get data from disk cause encryption

for example: 
Encryption: SSE (Server-Side Encryption) with PMK (Platform managed key). That means that key to decrypt this key is stored on platform.

You also have option "Customer keys for encryption":
> you can store your keys using "Azure key vault"
to make this:
>create key vault
>create key
>create disk encryption set
>encrypt disk with "disk encryption set"

Azure Disk Encryption:

os Windows (with bit locker) on Linux with DM-Crypt
Encrypt your disk volumes:
>create key in key vault
>open additional settings and enable disks to encrypt (OS and data disks), and choose current key.

IOPS - Input/Output operations per second (read and writes to data, for example from database)
Throughput - Amount of data is being sent to the storage disk at a specified interval (MB per sec)

Disk snapshot:

To make snapshot of disk on Azure:
>Create disk
>click "Create snapshot"

Snapshot it's READ-ONLY disk replica, but you can create disk based on snapshot (for exapmle, you will get data from snapshot on disk based on this snapshot)

Shared Disk:

Azure Shared Disk - This allows a managed disk to be attached to multiple virtual machine, can only enable for PREMIUM and ULTRA disks!

how to make:
>Create "Managed Disk"
>Configure VM's (this should be the same location as this share disk)
>To attach disk, you have to stop VM 

Manage and UnManaged Disks:

Managed disk - you get high availability. Because the data is replicated automatically on different places within Azure Data center.
Un-managed disk - you own disk, not managed by Azure and these disk will be stored in Azure blob's storage and then you can attach disk to the VM.

NOTE: You can't have both managed and un-managed disk with VM

Ok difference in cost. For the managed disk you will pay for all space (for example 128GB), in un-managed disk only for space wich you consumes.

The storage account disk type (premium SSD or standard SSD, HDD) should be the same like a disk for VM

how to make un-managed disk:
>create storage account
>on stage of creating VM, on "Disks" disable managed disks, and enable "Use ephemeral OS disk" and choose storage account

Un-managed disks stored in "vhds container" in storage account

Custom Script Extensions:

This tool can be used on Azure virtual Machines to download and execute scripts.
This is ideal when you want to deploy any custom configuration of any software installation on a virtual machine.
The scripts can be located in an Azure storage account or even on GitHub.
A time duration of 90 minutes is allowed for the script to run. Any longer and the result will be a failed extension provision.
It's ideal not to place reboots inside the scripts, because the extension will not continue after the reboot. Hence if have other commands that need to run via the extension after the reboot, they won't run.
If your scipt does need a reboot, then maybe you can look at other tools such as Desired State Configuration, Chef or Puppet.
The script will run only once.
The Custom Script Extension will run under the impersonation of the LocalSystem Account.

On Windows - PowerShell scripts.
On Linux - Bash scripts 

Cloud init - this is scripts like Script Extensions but in plain text way, you should not download script file and with Azure syntax
you could run Azure Scripts, example:

#cloud-config
package_upgrade: true
packages: 
	- nginx

Boot Diagnostics:

This is option to diagnostics for VM (during the time of VM)

Serial Console:

To use this option you have to use "Enable with custom storage account" in Boot diagnostics
Using serial console you could connect to VM using console

Run Command:

Useful option to run some scripts on running VM
 
Azure Bastion Service:

Azure Bastion Service - Fully managed PaaS service to connect to the VM's without public IP (throw this Bastion Host)
Provides RDP/SSH connectivity to virtual machines from the Azure Portal via TLS

Azure Bastion - must have subnet name "AzureBastionSubnet". This subnet will host Bastion compute instances
Then we should to assign public IP address to bastion.
Then to use just click "Bastion" in connection section (in VM menu)

Basic tier of Bastion host - can't change bastion compute instances
Standard tier of Bastion host - can change bastion compute instances

Availability sets:
An availability set is a logical grouping of VMs that allows Azure to understand how your application is built to provide for redundancy and availability

Using availiability sets you will get an SLA of 99.95% 

Fault domain - define the group of virtual machines that share a common power source and network switch (server rack). By default, the virtual machines configured within your availability set are separated across up to three fault domains.You can have up to 3 fault domains.
Update domain - Update domains indicate groups of virtual machines and underlying physical hardware that can be rebooted at the same time. You can have up to 20 update domains.

In 1 fault domain you can have a few update domains

Proximity placement group - store your machines closer together to get better communications, you can choose this option
ONLY when you create a virtual machine you can assign the availability set!

Availability zones:

Availibility zones - are unique physical locations that are equipped with independent power, cooling and networking.
There are normally three Availiability zones in region.

Using this we will get extra costs for bandwith

Using availiability sets you will get an SLA of 99.99% 

Using scale set, you can choose multiple availability zones

Azure Scale sets:

Scale set - this is tool to distribute the load on several machines instead of one. (for example: To scale from 1 machine to 3)
We can define the rules. The rule is based on a condition. Scale out - if the CPU percentage > 70% then add one machine, scale in - if the CPU percentage < 70 % then delete one machine
To define the scaling rule:

Open "Scaling" section in scale-set:
>enable "Custom autoscale"
>define the auto-scaling rule

There two types: 
>Uniform orchestration mode - Optimized for large scale stateless workloads with identical instances
>Flexible orchestration mode - achieve high availability at scale with identical or multiple virtual machine types

In uniform mode - you have separate API's of scale set to manage this VM's
in flexible mode - you have normal VM API's to manage VM. (resources creates like a separate VM)

VM Image:

Image - This is a copy of the full VM which includes the data disks or just the OS disk
You can create an image and place as part of an Azure compute gallery

You can share the Azure compute gallery across your organizations so that other users can create VM's based on the images stored in the gallery
Image Definition - This is a grouping of image versions. Each image definition has information about why the image was created and other information related to the image
Image Version - this is used to create the VM.
Two types of images that you can create:
>Specialized VM images. Here information about specific users and machine information is retained. So new VM's created out of the image will have the same computer name and admin user information.
>Generalized VM images. Here information about specific users and machine information is removed.  Here you have to perform the process of generalization. The original VM is unusable after you perform this process.

Generalized VM:
>on Windows you have path: C:/Windows/System32/Sysprep/  here will be app (sysprep)
>enable "Generalize" to prepare machine to Generalized Image (this app will remove all credentials, will prepapre machine and you will not have opportunity to use this VM more)


Azure Gallery - dataset of VM images, you can share gallery to others users in Azure

Resize VM:

>choose VM
>select section "Size"
>change size

Proximity Placement groups:

Normally when you create multiple virtual machines or virtual machines that are part of virtual machine scale set, these machines could be located in different data centers.
Sometimes an application/system that uses multiple virtual machines, want the virtual machines to be located closer together to get latency when it comes to communication between the virtual machines
By placing the virtual machines as part of a proximity group, the virtual machines will be physically located close to each other.
When using proximity placement groups, ensure the virtual machines have accelerated nerworking enabled. This also helps to improve network performance.
When deploying VM's from differents families or SKU's, try to deploy them as part of a single template. This will increase the probability of ensuring all VM's are deployed successfully.
A proximity placement group is assigned to a data center when the first resource (VM) is being deployed and released once the last resource is being deleted or stopped.

How to make:
>Create "Proximity Placement Group"
>choose create group in during creating VM

Azure Web App:

You don't have to maintain the underlying compute Infrastructure.
It has features such as Autoscaling and security.
It has DevOps capabilities which includes continuous deployement.

App Service planes:
>Free: max 10apps. Disk space - 1GB. Max instances - 0. Custom Domain - 0. Auto Scale - 0. Hybrid Connectivity - 0.
>Shared: max 100apps. Disk space - 1 GB. Max instances - 0. Custom Domain - Supported. Auto scale - 0. Hybrid Connectivity - 0.
>Basic: max apps - unlimited. Disk space: 10GB. Max instances - 3. Custom domain - Supported. Auto Scale - 0. Hybrid Connectivity - Supported.
>Standard: max apps - unlimited. Disk space: 50GB. Max instances - 10. Custom domain - Supported. Auto Scale - Supported. Hybrid Connectivity - Supported.
>Premium: max apps - unlimited. Disk space: 250GB. Max instances - 30. Custom domain - Supported. Auto Scale - Supported. Hybrid Connectivity - Supported.
>Isolated: max apps - unlimited. Disk space: 1 TB. Max instances - 100. Custom domain - Supported. Auto Scale - Supported. Hybrid Connectivity - Supported.

Free:

>Cores - 60 (CPU minutes / day)
>RAM - 1 GB
>Storage 1 GB
>Price: 0$ - free tier

Shared: 

>Cores - 240 (CPU minutes / day)
>RAM - 1 GB 
>Storage - 1 GB 
>Price: $0.013/hour per site

Depends on runtime stack (programming lang.) you have to choose: Linux or Win

You get a set of logging features that are available for the Azure Web App.
The different types of logging that are available are

Application Logging - This captures log messages that are generated by your application code.
Web Server Logging - This records raw HTTP request data.
Detailed Error Messages - This stores copies of the .htm error pages would have been sent to the client browser.
Deployement Logging - These are logs when you publish content to an application.
You can also stream logs in real time.

Deployment slots:

plans which supports slots: Standard, Premium and Isolated

Staging Environments for Web Apps
Applications in deployment slots have their own host names
You have the chance to validate all application changes in the staging deployment slot
You can then swap the staging slot with the production slot
This helps eliminate the downtime for your application when new changes are deployed
You can also easily roll back the changes

To upgrade plan: 
>in section "Scale up"
>change plan

Auto scaling of Web App:
>in section "Scale out"
>"custom auto scaling"

Cool down - You can also set something called a “cool down” period. This is the number of minutes to wait after a scaling operation before it can scale again. 
By default, it's set to 5 minutes. This gives the metrics a chance to stabilize again after the scaling operation. During this time the scaling process should not take into account any metrics or thresholds that get breached.
Cool down

Azure Web App VNET Integration:

Allows the App service to access resources within the VNET. But it does not allow private inbound access to your Web App from the virtual network.
use case scenario:
>to allow connect from Web App server to the DB server in your vnet

Custom Domains in Web App:

In section "Custom Domain" click "Add custom domain"

then on your domain portal add:
>TXT record
>A record

You have to wait about 1 hour

To add SSL cert:

"Create ssl cert"

Azure Web App Backups:

The backup feature that is available with Azure Web App can be used to create backups of your web app.
The backups are stored in an Azure storage account.
Here the configuration, the file content and the database connected to the application get backed up.
To use the Backup and Restore feature, the App Service Plan needs to be in the Standard, Premium or Isolated tier.
Backups of the app + database can be up to a maximum of 10 GB.

To make:
>click "Backups"
>choose backup storage
>set backup schedule

Containers:

Containers helps to package the application along with libraries, frameworks and dependencies that are required.

Docker - This is an open platform that is used for developing, shipping and running applications.
Docker has the ability to package and run an application in a loosely isolated invironment called a container.
Docker image - this is read-only template with instructions that are required to create the Docker container.
Container - This is a runnable instance of an image.

To deploy docker image on Azure:
>create "container registry"
>build Docker image (if gonna deploy to ACR - Azure container registry) then should set a name like this: "name_of_registry.azurecr.io/name_of_app":latest
>get azure-cli: apt-get install azure-cli
>login to the azure: az login
>login to repo: az acr login --name "reponame"
>docker push "name_of_registry.azurecr.io/name_of_app":latest

To deploy container to Azure:
>In "container registry" in section Access keys enable "Admin user"
>create "Container instance"

To deploy container group we should use deployment config file such deployment.yml :
apiVersion: 2019-12-01
location: northeurope
name: AppGroup
properties:
  containers: 
  - name: app
    properties:
      image: appregistry10002313.azurecr.io/myapp:latest
      resources:
        requests:
          cpu: 1
          memoryInGb: 1.5
      ports:
      - port: 80   
  osType: Linux
  ipAddress:
    type: Public
    ports:
    - protocol: tcp
      port: 80    
  imageRegistryCredentials:
    - server: appregistry10002313.azurecr.io
      username: appregistry10002313
      password: RGhhcWieDFffTCZ2DPYe=QEDqKr4NGbI
type: Microsoft.ContainerInstance/containerGroups

then upload this file to the CloudShell and execute by this command:
>az container create --resource-group container-grp --file deployment.yml

Kubernetes (K8S):

Azure Kubernetes - Managed service for Kubernetes on Azure
Kubernetes is used to orchestrate your containers for hosting your apps

Kubernetes containes:
>Kubernetes cluster - These are used for hosting your containers
>Master node - is used to control the nodes in the cluster
>slave nodes - executes commands from master nodes
>api server - all calls to the cluster from user, ONLY by api
>kubenet - kubernetes isolated network
>kubelet - This is a kubernetes agent that runs on the node. Kubelet - it registers the node with the master node. Will take commands from the master node for the deployement of containers
>Container runtime - This is used to actually taking the images and deploying the containers on the node.
>Kube-proxy is used for managing the networking aspects for the containers.

To deploy kubernetes cluster:

>create kubernetes cluster

to deploy container to cluster use deployement.yml: 

apiVersion: apps/v1
kind: Deployment
metadata:
  name: myapp-deployment
  labels:
    app: myapp
spec:
  replicas: 1
  selector:
    matchLabels:
      app: myapp
  template:
    metadata:
      labels:
        app: myapp
    spec:
      containers:
      - name: myapp
        image: appregistry10002313.azurecr.io/myapp:latest
        ports:
        - containerPort: 80

To run containers as service use service.yml:

apiVersion: v1
kind: Service
metadata:
  name: app-service
spec:
  type: LoadBalancer
  ports:
  - port: 80
  selector:
    app: myapp

Networking in kubernetes Azure:

1.Kubenet - Nodes receive an IP Address from the Azure virtual network. Pods recieve an IP address from a logically different address space to the Azure virtual network subnet..Network Address Translation is then used (NAT)
2. Azure Container Networking Interface. Every pod gets an IP address from the subnet and can be accesed directly

Kubernetes configure storage:

Azure Premium disks - Disks are only available to a single pod.
Azure files - File shares can be accessed via multiple nodes or pods.

How to make attach disk to deployement pod:

1. Ensure to first get the credentials of your cluster in Azure Cloud Shell

az aks get-credentials --resource-group test-grp --name democluster

2. Get the resource group which holds the nodes of your Azure Kubernetes cluster

az aks show --resource-group test-grp --name democluster --query nodeResourceGroup -o tsv

3. Then create a disk. Ensure to change the resource group details accordingly

az disk create --resource-group MC_test-grp_democluster_northeurope --name clusterdisk --size-gb 20 --query id --output tsv

4. Use the following app.yml file as a reference for the deployment of a pod with the use of the disk

apiVersion: apps/v1
kind: Deployment
metadata:
  name: app-deployment
spec:
  replicas: 1
  selector:
    matchLabels:
      app: my-app
  template:
    metadata:
      labels:
        app: my-app
    spec:
      containers:
      - name: my-image
        volumeMounts:
          - name: storage
            mountPath: /mnt/disk1
        image: nginx
        ports:
        - containerPort: 80
      volumes:
          - name: storage
            azureDisk:
              kind: Managed
              diskName: clusterdisk
              diskURI: /subscriptions/20c6eec9-2d80-4700-b0f6-4fde579a8783/resourceGroups/MC_test-grp_democluster_northeurope/providers/Microsoft.Compute/disks/clusterdisk

How to attach azure file share to K8S deployement:

1. Set variables for the storage account name and the access key

$AKS_STORAGE_ACCOUNT_NAME="newstore40000"

$STORAGE_KEY="SOME_KEY"

2. Then create a secret in the Kubernetes cluster

kubectl create secret generic azure-secret --from-literal=azurestorageaccountname=$AKS_STORAGE_ACCOUNT_NAME --from-literal=azurestorageaccountkey=$STORAGE_KEY

3. Use the following app.yml file as a reference for the deployment of a pod with the use of the file share

apiVersion: apps/v1
kind: Deployment
metadata:
  name: app-deployment
spec:
  replicas: 1
  selector:
    matchLabels:
      app: my-app
  template:
    metadata:
      labels:
        app: my-app
    spec:
      containers:
      - name: my-image
        volumeMounts:
          - name: storage
            mountPath: /mnt/share
        image: nginx
        ports:
        - containerPort: 80
      volumes:
          - name: storage
            azureFile:
              secretName: azure-secret
              shareName: newshare
              readOnly: false

=================================

Configure and manage virtual networking

=================================

Azure Virtual Network - Isolated network on the cloud

The network interface - hardware or virtualized hardware that connects your PC to network
network will get (private/public IP)

To create virtual network:
>create "Virtual network"

default allocating of network:

>10.0.0.0/16
>defautl subnet 10.0.0.0/24

How to add secondary network interface to VM:
>search for "network interface" resource
>create this "network interface" (create this in particular network/subnet)
>attach this to the VM

NSG - Network Security Groups:

The purpose of NSG is filtering of traffic inside of Virtual Network

There are:
>Inbound rules ( rules to define which traffic should allow/deny during INSIDE to the some host)
>Outbound rules ( rules to define which traffic should allow/deny during OUTSIDE of the some host)

Using this rule may define:
>Priority
>Port number
>Protocol
>Source and Destination

You can attach NSG or to Virtual Network Interface or Subnet but NOT to Virtual Network

By default you have 3 rules:
>65000 AllowVnetInBound - to allow traffic from Virtual Network
>65001 AllowAzureLoadBalancerInBound - to allow load balancer traffic
>65500 DenyAllInBound - to deny other traffic 

Each rule have:
>Port
>Protocol
>Source
>Destination
>Action (Deny/Allow)

Rules priority:

rules will be checking by increasing of priority number.
Example:

>RuleDenyHTTP - Priority - 200 (deny port 80 to machine 192.168.1.1)
>RuleAllowALL - priority - 300 (allow all traffic to machine 192.168.1.1)
In this case traffic will be denied cause rule with priority number 200 was matched, and others rules will not be evalueted

NSG on Subnet and VM:
>NSG rules on Subnet will evaluated first, then NSG rule on VM will be avaluated( if it will not be filtering by subnet NSG rules)

Azure Load Balancer:

This is service to distribute traffic between VMs.
In OSI model this is L4 

To use Load Balancer we have config:
>Backend pool (set of VMs wich will be served by this LB - Load Balancer)
>Public IP address (to attach to LB)
>Health Probe
>Load balancing rule

Load Balancer have 2 SKU's - 2 pricing plans:
>Basic Load Balancer:
	>Free
	>The machines in the backend pool need to be part of an availability set or scale set
	>Health probes: TCP, HTTP
	>Avaiability zones: Not Supported
	>SLA: Not supported

>Standard Load Balancer:
	>Charge per hour
	>Here the machines can also be independet machines that are part of a virtual network as a load balancer and the same location
	>Health probes: TCP,HTTP,HTTPS
	>Avaialability zones: Supported
	>SLA: 99.99%

To create a simple infrastructure with Azure Basic Load Balancer:
>Create some VMs with IIS service (better choice to do it using "Custom script extension") and during create choose "availability set", for demo you can add "text 1 and 2 " to machines to check how LB will distribute requestst :)
>Create Public IP address 
>Enable static private addreses on machines
>Create Load Balancer

During config of LB rule, we have to config Front-End IP, Protocol, Port of LB, and Backend Port ( port of machines)

NAT - Network Address Translation
NAT inbound rules - you can use this to get translated IP addresses for backend poll VMs

Better choice to use redirect port (LB port) is port from Ephemeral ports:
>form range: 49152-65535 this is temporary ports

Using this you can connect to VM using front-end ip and enter different (temporary port, which will redirect you to RDP for example) and get access to VM even without Public IP.
To use "Custom Script Extension" on the existing scale set:

1. Add the following to the install.ps1 file

Add-WindowsFeature Web-Server
Set-Content -Path "C:\inetpub\wwwroot\Default.html" -Value "This is the server $($env:computername) !"
2. Execute the following commands for custom script extensions

$config = @{
  "fileUris" = (,"https://webstorelog1000.blob.core.windows.net/script/install.ps1");
  "commandToExecute" = "powershell -ExecutionPolicy Unrestricted -File install.ps1"
}
 
$set = Get-AzVmss -ResourceGroupName "test-grp" -VMScaleSetName "demoscaleset"
$set = Add-AzVmssExtension -VirtualMachineScaleSet $set -Name "customScript" -Publisher "Microsoft.Compute" -Type "CustomScriptExtension" -TypeHandlerVersion 1.9 -Setting $config
Update-AzVmss -ResourceGroupName "test-grp" -Name "demoscaleset" -VirtualMachineScaleSet $set

to use multipools:
>You can choose port (of LB) for example on pool A 80 => 80 , on pool B 8080 => 80
>You can create second front end IP address and attach this address to the second pool
>Using second Front-End IP address we can map same port number on LB for using NAT rules

The load balancer will create an affinity between the Load Balancer and the client for a session
Advantage - Can help in better performance for sessions.
Disadvantage - if too many sessions are persisted on a server.

Azure Application Gateway:

App Gateway - OSI Layer 7 Load Balancer
The web apps can reside on Virtual Machines, VM's scales sets, or even on-premise servers.
This supports for Secure Sockets Layer Termination (SSL/TLS)
Here request to the APP Gateway can be secure
And then the requests to the backend pool resources can go unencrypted.
This can lift the burden of the backend pool for decrypting requests


When you deploy an Application Gateway you should have an empty subnet
You can use it for:
>Using Web App Firewall
>For route traffic by /path on differents VM pool

You can also enable Autoscaling for App Gateway resource.
This allows the App Gateway to scale up or down on traffic load patterns.
You can also enable the Web App FireWall feature for the App Gateway resource.
You can also enable session affinity which allows a user session to directed to the same server for processing. If the state of the user session is stored on the server, then this can be a useful feature.

Components of App Gateway:
>Frontend IP address
>Listener - this is a logical entity that checks for incoming connection requests. There can be multiple listeners attached to an application gateway. There 2 types of Listeners:
	>Basic - Here the listener listens to a single domain site.
	>Multi-site - Here the listeners maps to multiple domain sites.
>Routing Rules - This is used to route the traffic from the listener to the backend pool. There 2 types of routing rules:
	>Basic - Here all requests are routed to backend pool directly.
	>Path-based - Here requests are routed to the backend pool based on the URL in the requests.
>Backend pools - These can be Network Interface cards, VM scale sets, Public or Internal IP addresses, FQDN or backends such as App Service.
>Health Probes - This defines how the application gateway will monitor the health of the resources in the backend pool.

How to make:
>Create vnet with empty subnet for AppGeteway
>Create VM's and attach to this vnet
>Create Backend pools
>Listener and Backend targets
>create HTTP/HTTPS settings

In case of Multiple dns names:
>additionally attach dns name to pub-ip of App LoadBalancer
> then add to your domains CNAME of APp gateway dns name

Virtual Network Peering:

Virtual Network Peering is used to connect two Azure virtual networks together via the backbone network.
Azure supports connecting two virtual networks located in the same region or networks located across regions.

Once you enable virtual network peering between two virtual networks, the virtual machines can then communicate via their private IP addresses across the peering connection.
You can also peer virtual networks that are located across different subscriptions.

The virtual networks can't have overlapping CIDR blocks.

How to make:
>create at least 2 Vnets with different CIDR blocks (they can't match)
>Click on "peerings" and add new peering connection on each network (at least in one, on the second vnet it's will appear by default)

VPN:

VPN - Virtual Private Network

Your Internet Services provider will know all of the requests that are made from your machine onto the Internet.
Sometimes privacy can always be a concern
VPN is used to create a private network
Here your public IP address is not placed in the requests that are made onto the Internet
Also VPN connections are encrypted so that the data transfer is more secure

Point-to-Site VPN connection

A Point-to-Site VPN connection is used to establish a secure connection between multiple client machines an an Azure virtual network via the Internet.
 
It's used for remote work, when you have to connect from your PC to antother private network
The gateway subnet is used to host gateway VM's and services
The VM's in the gateway subnet are configured with the required VPN gateway settings

How to make Point-to-Site VPN:
>Create a vm
>Create a Vnet with VPN gateway subnet (name like: "GatewaySubnet")
>Create Vnet gateway
>Generate Self-Signed root cert
>Generate Client cert
>In section "Point-to-site config" create configuration
>

To generate Self-Signed Root cert:
$cert = New-SelfSignedCertificate -Type Custom -KeySpec Signature `
-Subject "CN=VPNRoot" -KeyExportPolicy Exportable `
-HashAlgorithm sha256 -KeyLength 2048 `
-CertStoreLocation "Cert:\CurrentUser\My" -KeyUsageProperty Sign -KeyUsage CertSign

To generate Client cert (it'c generating based on Root cert):
New-SelfSignedCertificate -Type Custom -DnsName VPNCert -KeySpec Signature `
-Subject "CN=VPNCert" -KeyExportPolicy Exportable `
-HashAlgorithm sha256 -KeyLength 2048 `
-CertStoreLocation "Cert:\CurrentUser\My" `
-Signer $cert -TextExtension @("2.5.29.37={text}1.3.6.1.5.5.7.3.2")

CIDR block for gateway subnet:
>min: /29
>recommended: /27, /26

To authenticate your machine during VPN connection, use certificates:
>Root cert - Self-Signed Root Certificate
>Client cert - Installed on laptops for connect to the VPN

Site-to-Site VPN:

It's used to VPN connection between 2 networks for example on-premise network and Azure Vnet

How to make:
>Create VM for routing (with pub IP) and install "DirectAccess and VPN" REMEMBER SHARED KEY (you will use this to configure connection Site-to-Site)
>Create a Vnet with VPN gateway subnet (name like: "GatewaySubnet")
>Create Vnet gateway
>In section "Connections" create "Site-to-site" Connection 
>Create Local Network Gateway (Here you have to enter your on-premise network details "IP" "Address space")

Azure virtual WAN:

Azure virtual WAN - tool to connect Vnets, on-premises servers in one infrastructure
Hub - You create a virtual hub in the virtual WAN resource. This is a Microsoft-managed virtual network.
You then connect the various endpoints to the Hub - Azure virtual network, Site-to-Site

To make:
>create virtual WAN
>create virtual hub
>In section "virtual network connection" of virtual WAN create connections

Azure ExpressRoute:

Allows you to connect your on-premises networks to Microsoft cloud over the private connection.
Here the connection is established with the help of a connectivity provider.

By default you get 2 connections to more redundancy.

How to create:
>Create ExpressRoute

Standard SKU - Only 1 Azure region
Premium SKU - Multiple Azure region

Network Wacther Service:

This is tool to monitor your network
Connection Monitor - Check the network connectivity between machines. These can be in Azure or on your on-premises environments.
IP flow Verify - This can be used to check if a packet is allowed or denied to or from a virtual machine. If a packet is being denied by a security group, you can see which rule is denying the packet.
Next hop - Here you can see the next route for you understand whether tha packet is being routed to the correct destination.
Connection troubleshoot - Check the connection from a virtual machine to a virtual machine, fully qualified domain name, URI or IPv4 address.
NSG Diagnostic - Provides detailed information that helps to understand and debug the security configuration of the network.
Traffic Analytics - This helps to log information about the IP traffic that is flowing through an NSG.
NSG Flow Logs - Helps to provide visility into 

Connection Troubleshoot VM:
>IN section "connection troubleshoot" check source, dst , protocol to test

Connection monitor:
>In Network Watcher you have a lot of monitoring tools
>create "connection monitor"
>Log analytics workspace - centralized solution to store your network logs

Ip flow verify:
>In Network Watcher you have a lot of monitoring tools
>create "IP flow verify"

Next hop:
>In Network Watcher you have a lot of monitoring tools
>create "Next hop"

NSG Diagnostics:
>Assign target subnet to Network Watcher
>Create "NSG Diagnostic"

NSG Flow Logs:
>To store your logs we have to create new "Storage acc" (or use existing)
>Create  "flow log" in network watcher
>In create storage acc after deploying new "Flow Log" will appear logs container

Flow logs in JSON format:
>UniTime format
>Source IP
>Destination IP
>Source Port number
>Destination port number
>TCP/UDP
>Inbound/Outbound
>Deny/Allow

User define routes:

Like a user you can define specific way to distribute traffic (for example , throw the forward server with FireWall)

how to forward traffic from SubnetA throw the Central subnet to subnet B:
>Create 3 VMs in different subnets
>Create route table, during creating select "Virtual appliance" and set "address prefix" as address of whole vnet, like a next hop address set IP of central-VM
>After creating route table, associte subnets to this route table
>On centralVM in network interface => ip configurations => Enable IP forwarding
>Enable IP forwarding on central VM => install "Remote Access" throw the Server Manager => "Routing"  and "DirectAccess" => Start installed soft => "Deploy VPN only" => click centralvm and enable "Enable routing and remote Access" => Configure LAN routing

Azure FireWall:

Has built-in high availability.
Can deploy the Azure FireWall Instance across two or more Availability zones - 99.99% SLA
You can filter traffic based on fully-qualified domain names
You can also create network filtering rules Based on source and destination IP address, port and protocol
It is stateful in nature, so it understands what packets of data to allow
It has built-in Threat Intelligence - Here you can get alerts or deny traffic from/to malicious IP addresses and domains

How to make:
>Create special subnet "AzureFirewallSubnet" /24 CIDR block
>Create Firewall by "Microsoft"
>In section "FireWall policy" => DNAT Rules => Add a rule collection
>You can add "Route Table" and associate our VM subnet => then create route to connect to the Internet throw the FireWall
>Add "Application rules" in "Firewall policy"

DNS:

DNS - Domain Name System

How to associate DNS name with VM:
>Buy domain name 
>Paste pub IP to the Domain Name portal on  - A record

How to create Internal DNS in azure vnet:
>Configure DNS server VM => Install "DNS server" 
>Configure other VMs to work with this DNS server
>In vnet settings section "DNS servers" => Enter IP address of DNS server VM
>Create new A record in DNS server

Private DNS:
>Configure "DNS servers" as azure
>Create Private DNS zone
>Add virtual link to current Azure Vnet and Enable "Auto registration"

Public DNS:
>Create DNS zone, this service just allow to have "DNS zone" you still have to be owner of particular DNS name
>Cange NS records - to the Azure Public DNS zone ns records after this request will be redirected to the Azure Public DNS zone 
>Add record set to the Public DNS => Associate public IP address to the root domain


=====================================================================

Azure Implement and manage storage

=====================================================================

Azure Storage Accounts - This provides storage on the cloud

Storage services:
>Blob
>Table
>Queue
>Fileshare

Storage account types:
>Standard General Purpose V2:
	>Blob
	>File shares
	>Queues
	>Tables
>Premium block blobs (This is supported for block and append blobs), when you want to fast access to your blobs high transaction rates:
	>blobs
>Premium Page blobs (Used for virtuals disks images, disks):
	>blobs
>Premium file shares (this is for fast access to your files in fileshare):
	>file shares
	
Blob service:

This service is optimized for storing large amounts of unstructure data.
To store files we have to create container.
The all files will uploaded as a separate object. Each object will have uniq url

Block blobs - This is made up of blocks of data that can managed individually.
Append blobs - These are block blobsthat are optimized for append operations - Good for logging
Page blobs - This is used for virtual hard drive files for Azure virtual machines.

Access to the blob:
Every blob object URL creates by: azure blob storage name + container name + file name = appstorage4040.blob.core.windows.net/data/AZ-104.JPG
By default as admin you have access to files in portal Azure
You can change access to container level:
>private (no anonymous access)
>Blob (anonymous read access for individual blobs only)
>Container ( anonymous read access for containers and blobs) Itread - user will be able to list objects within the container

Different authorization techniques:
>Access Keys
>Shared Access Signatures
>Azure Acitve Directory

Azure storage explorer:

This is desktop tool to explore Azure Storage accounts,containers,blobs, etc.

Access Keys:

This used to give to someone access to Storage account

How to make:
>In storage account in section "Access keys"
>Using this key in "Azure storage account explorer" => in section "Storage account or service" use this keys to see files

In this case user will get access to all services and all data in the Storage Acc

Shared Access Signatures - Blob Level:

How to make:
>Select file and "Generate SAS"
>Generate SAS token and URL

Using this URL we can get access to particular blob

Shared Access Signatures - At the Storage Account Level

To get Shared Access Signatures at the account level.

How to make:
>In Storage acc. in section "Shared access signature" here we can choose allowed services, permissions etc.
>Generate SAS and connection string

But you can't use Web Browser for use generated URL, you HAVE to USE Azure Storage Explorer

Stored Access Policy:

>You can create in section of container "Access Policy" => Stored Access Policy
>Then in Azure Storage Explorer => in particular conatiner click "Shared Access Signature" => Attach created policy
>Then using created SAS url (In Storage Explorer) we can attach our container as anonymous user

If this SAS came to the wrong hands:
>You can desable all permissions from this policy

Active Directory Authentication:

We can give access using Azure AD:

>In storage account => Access Control => Add role assignment 
>Give access to particular user or user group

Then using for example Azure Storage Explorer current user will have access

Data redundancy:

Multiple copies of your data are stored
This helps to protect against planned and unplanned events - transient hardware failures, network or power outages.

Types of storage redundancy:
>Locally-redundant storage:
	>When you upload your data file, there will be 3 copies. It helps to protect against server rack of drive failures
	>But if Data Center will go down - you will lost the data.
>Zone-redundant storage:
	>Here data is replicated synchronously across three Azure availability zones
	>Each availability zone is a seperate physical location with independent power, cooling and networking.
>Geo-redundant storage:
	>Your data will be replicated in another region
	>Regions where Azure will store your files - Paired Regions
	>Data is copied three times in the primary region using LRS then data will copied 3 times in the secondary region using LRS
>Read-access geo-redundant storage:
	>if the requirement that app should get access to data even if primary region is go down
	>Costs will increase
Geo-zone-redundant storage:
	> in Primary region data will replicated by zone redundant storage

Configuring Storage Redundancy:

In storage account "configuration" you can change it redundancy
Azure storage Tier:

Pricing blob storage:
>First 50 TB/month: Premium: 0.15$ per GB. Hot: 0.0184$ per GB. Cool: 0.01$ per GB. Archive: 0.00099 per GB
>Next 450 TB/month: Premium: 0.15$ per GB. Hot: 0.0177$ per GB. Cool: 0.01$ per GB. Archive: 0.00099 per GB
>Over 500 TB/month: Premium: 0.15$ per GB. Hot: 0.0170$ per GB. Cool: 0.01$ per GB. Archive: 0.00099 per GB

Hot access tier - This is used for data that is accessed frequently
Cool Access tier - This is used for data  that is  accessed infrequently and stored for at least 30 days
Archive Access tier - This is used for data that is rarely accessed and stored for at least 180 days

Hot and Cool Tier:

This tier config you can apply for Account storage level or for Blob Level
In "Configuration" of storage acc => Cool/Hot config

Archive Access tier:

This can be applyed for the blob level
If you will enable the "Archive" tier you will not get access to the file until you will not enable "Hot" Access tier and "Rehydrate priority" (standard/high)

>click on file and choose "Archive" tier

LifeCycle policies:

Useful case: you have a lot of files and you have to change some files to "hot"
Transition: Here you can transition blobs from the cool to the hot access tier to save on storage costs.
Blobs: You can transition blobs,blob versions and blob snapshots
Deletion: You can also define rules to delete blobs, blob versions and blob snapshots
Rules: Rules can be applied at the storage account level or to a subset of blobs

Lifecycle managment:
>Rule fileters: you can define filters for blobTypes - blockBlob, appendBlob.
>Rule actions: You have actions such as tierToCool, tierToArchive and delete.
>Support: Rules are supported for blob and append blobs in General-Purpose V2 accounts, Premium Block blob and blob Storage accounts.
>Region: This feature is available in all regions.

In storage account in section "Lifecycle management" => Add rule => define the rule

Object replication:

How to copy container:
>Create another storage account (For test)
>Create destination container in new storage account
>In new storage account in section "Data protection" enable "Versioning for blobs"
>In source storage account in section "Data protection" enable "Versioning for blobs" and "Blob change feed"
>In source storage account in section "Object replication" => Create replication rules

Azure file shares:

You can access to file share via Server Message Block Protocol (SMB)

How to make:
>Create file share (For example "transaction optimized")
>From start you can edit fileshare size (from 5TB to 1GB for example)
>To connect this fileshare on WinMachine click connect in section "FileShare" container => choose OS Windows and copy and exute script in PowerShell

This fileshare will be connected by port 445

Firewall and network settings for Storage Account:

In section "Firewalls and virtual networks"
Here you can configure particular VNETs and IP to access to current Storage

Azure file Sync:

This option used for sync particular files on VMs
How to make:

Be careful this service too hard to delete :) it's takes a lot of time, you have to be ready for the big costs.

>Create Azure file sync
>On VMs Download/Install Azure File Sync agent
>In azure file sync create Sync group
>Then login in azure sync agent on each VM
>Add server endpoints

This file share will sync files only created on VMs, not directly in fileshare in Azure

Azure Import/Export:

Copying Data - this is used for copying large amounts of data to Azure Blob storage and Azure files.
Transfer Data - You can also transfet data from Azure Blob storage to your on-premises environment.
Disk Drives - Here you make use of Disk Drives. You can use your own Disk drives or use the ones provided by Microsoft.
Jobs - You basically create a job via the Azure Portal. This will be used for transferring data to a storage account.

Import/Export Service - This is available in the Azure Portal. It helps to track the data import or export job.
WAImportExport tool - It prepare the disk drives that are required for import. 
It helps to copy the data onto the disk drive. It encrypts the data on the drive. It generates the drive journal files that are used during the import creation.
It helps identify the number of drives needed for the export jobs.

Data box:

>Data transfer - Helps to send terabytes of data in and out of Azure
>No internet - You don't need to use your Internet connection to transfer the data
>Scenario - Ideal when you want to transfer data sizes that are larger than 40 TB
>Device - You order the Data Box device via the Azure Portal



AzCopy tool:

When it comes to authorization with Blob storage , only Shared Access Signature and Azure AD are the supported methods.

This is tool for multiplatform: Linux, Win , MacOS
For this we have to generate SAS - Shared Access Signature

Useful commands using AzCopy:

Remember to change the Shared Access Signatures

1. To create a container
azcopy make "https://appstore4040.blob.core.windows.net/tmp?sv=2020-08-04&ss=b&srt=sco&sp=rwdlac&se=2021-12-13T14:36:11Z&st=2021-12-13T06:36:11Z&spr=https&sig=RtWuKGVi%2BTp1yW1VNAqgSFMmFtrRrEsQ9f%2BJy7LuIZU%3D"

2. To upload a file
azcopy copy storage1.arm.json "https://appstore4040.blob.core.windows.net/tmp/storage1.arm.json?sv=2020-08-04&ss=b&srt=sco&sp=rwdlac&se=2021-12-13T14:36:11Z&st=2021-12-13T06:36:11Z&spr=https&sig=RtWuKGVi%2BTp1yW1VNAqgSFMmFtrRrEsQ9f%2BJy7LuIZU%3D"

3. To upload a directory
azcopy copy "newdir/*" "https://appstore4040.blob.core.windows.net/tmp?sv=2020-08-04&ss=b&srt=sco&sp=rwdlac&se=2021-12-13T14:36:11Z&st=2021-12-13T06:36:11Z&spr=https&sig=RtWuKGVi%2BTp1yW1VNAqgSFMmFtrRrEsQ9f%2BJy7LuIZU%3D"

4. To upload a directory to a directory in the container
azcopy copy "newdir/*" "https://appstore4040.blob.core.windows.net/tmp/newdir?sv=2020-08-04&ss=b&srt=sco&sp=rwdlac&se=2021-12-13T14:36:11Z&st=2021-12-13T06:36:11Z&spr=https&sig=RtWuKGVi%2BTp1yW1VNAqgSFMmFtrRrEsQ9f%2BJy7LuIZU%3D"

5. To upload a directory and subdirectories to a directory in the container
azcopy copy "newdir/*" "https://appstore4040.blob.core.windows.net/tmp/newdir?sv=2020-08-04&ss=b&srt=sco&sp=rwdlac&se=2021-12-13T14:36:11Z&st=2021-12-13T06:36:11Z&spr=https&sig=RtWuKGVi%2BTp1yW1VNAqgSFMmFtrRrEsQ9f%2BJy7LuIZU%3D" --recursive

6. Download blob data
azcopy copy "https://appstore4040.blob.core.windows.net/tmp/storage1.arm.json?sv=2020-08-04&ss=b&srt=sco&sp=rwdlac&se=2021-12-13T14:36:11Z&st=2021-12-13T06:36:11Z&spr=https&sig=RtWuKGVi%2BTp1yW1VNAqgSFMmFtrRrEsQ9f%2BJy7LuIZU%3D" "storage1.arm.json"

7. copy data between two storage accounts
azcopy copy "https://appstore4040.blob.core.windows.net/tmp?sv=2020-08-04&ss=b&srt=sco&sp=rwdlac&se=2021-12-13T14:36:11Z&st=2021-12-13T06:36:11Z&spr=https&sig=RtWuKGVi%2BTp1yW1VNAqgSFMmFtrRrEsQ9f%2BJy7LuIZU%3D" "https://azcopydestination100034.blob.core.windows.net/tmp?sv=2020-02-10&ss=b&srt=sco&sp=rwlac&se=2021-04-12T22:26:24Z&st=2021-04-12T14:26:24Z&spr=https&sig=TMv5LmpR0RKwpg%2B8F19Q1aLNlKUyn36%2B0B5qqu5fGok%3D" --recursive

Zone Redundant data storage:
>General-purpose V2
>Premium block blobs
>Premium file shares

You can't set access tier at on object level for General Purpose V1,Premium block blobs, Premium file shares

=================================================

Manage Azure identities and governance

=================================================

How to create Subscription:
>Enter subscriptions in Azure portal search => "Add subscription"

Azure Active Directory:

This is your identity provider in Azure.
Using this service we can manage our users and Role-based access control.

Azure tenant - This is a dedicated and trusted instance of Azure AD.
Azure AD directory - Each Azure tenant has a dedicated and trusted Azure AD directory. This includes the tenant's users, groups and applications and is used for performing identity and access management onto resources.
You can map Subscription only to ONE Azure tenant (directory)

How to create user in Azure AD:
>In section "Users" => "New user" 
By default after creating new user - user have not access to resources.

Built-in Roles:

Contributor - Grants full access to manage all resources, bud does not allow you to assign roles in Azure RBAC, manage assingments in Azure Blueprints or share image galleries.
Owner - Grants full access to manage all resources, including the ability to assign roles in Azure RBAC.
Reader - View all resources, but does now allow you to make any changes.
User Access Adminitrator - Lets you manage user access to Azure resources.

How to grant role to VM:
>In VM in section "Access control (IAM)" => "Add role assignment" => grant Built-in role to particular user.

How to grant role to Resource Group Level:
>In Resource Group in section "Access control (IAM)" => "Add role assignment" => grant Built-in role to particular user.

How to grant role at the Subscription level:
>In Subscription in section "Access control (IAM)" => "Add role assignment" => grant Built-in role to particular user.

Custom roles:

You can define custom role

In section "Access control (IAM)" => "Add" => "Add custom role"

Azure AD licenses:

>Azure Active Directory Free
>Azure Active Directory Premium P1
>Azure Active Directory Premium P2

how to change:
>Go to default Azure Active Directory => "All products" => Try/Buy then select particular license

How to create Azure AD group:
>Select Azure Ative directory => Groups => New group

Dynamic Group:
To work with dynamics group you HAVE use Premium License 

>Select Azure Ative directory => Groups => New group in membership type enable "Dynamic User" => Add dynamic query

Azure AD another roles (custom):
RBAC - has several Azure built-in roles that you can assign to users,

>In section "Roles and administrators" => Search particular role => Assign to user

Azure AD Custom Domains:

>Azure AD => In section "Custom Domain names" => Add custom domain => replace TXT record

How to join VM to Azure AD:

During creating machine in a management section enable "Login with Azure AD"
Supports: Windows 10, Windows Server 2019, MacOS, Android

Dynamic Device Group:

>In Azure AD => Create Group => Membership Type "Dynamic Device"

When you manage your devices, you can manage the settings via Device settings in your Azure AD directory
1) The below setting by default allows all users to have the ability to join their devices to Azure AD. If you want you can also define selected users who could perform this operation

Note:-  This is only valid for Windows 10 devices
This is intended for companies who want to just use the cloud option and not use their on-premise devices

2) Next we have the local administrators option.
Here you can decide which users are automatically added as Administrators to domain joined devices

Note:- This option would only be available if you have Azure AD Premium licences. If you have Azure AD Free , you probably won't see this option.
By default , Global administrators and device owners are added as local administrators on the domain joined devices

3) Next we have device registration
This is applicable when users want to register devices such as Windows 10, iOS, Android, MacOS using their personal Microsoft account or another local account.
This is meant for those organizations who also have devices on different platforms on their on-premise environments

4) Next we have the condition wherein you want to impose Multi-Factor Authentication for users to join devices. This ensures a legitimate user is adding the right device.
5) Next you can also define the maximum device registration per user

Self-service password reset:

This feature helps users to reset their password without the need of contacting the IT help dest staff.
For this feature requirements:
>Premium Azure AD

Password writeback - If there is a hybrid environment, the changed passwords can be written back to the on-premises Active Directory.
Authentication Methods - You can define authentication methods to reset the passwords.
Number of methods - Define the number of authentication methods required to reset the password.
Nubmer of days - Number of days before user need to reconfirm their authentication information.
Notification - Notify users when password is reset.

How to enable self-service password reset:
>In Azure AD => password reset

Guest-user:
This is temporary users

How to invite guest user:
>In azure AD => Users => New Guest User

Bulk create and delete users:
>Azure AD => Users => Bulk operations (then you have to download and edit or upload existing template file in .csv format)

MFA - Multi Factor Auth:

How to enable MFA per user:
>In Azure AD => All users => Per-user MFA

Conditional Access policies:
For using this reqiere the Azure Premium AD

How to use Access policies:
>In Azure AD => Security => Conditional Access
Usign this policy we could create requirement to use MFA for example.

Administrative Units:
This used for logical seperating you Azure AD users (Like for departments). You can set admin for each department

How to create:
>create users and groups
>Create users Administrators
>Create administrative unit 
>Add users and groups to the admin. units

When you adding group of users (in this Admin unit), you ONLY can manage for a group NOT for users within the group.
If user didn't assigned to the admin. unit he will be admin of Azure AD, he will get access to the whole AD.

Resource tags:

This can be used to organize your resources.
Each tag consist of a name and a value pair.

Moving resources across resource groups:

When you move particular resources to another region (resource group) their region will not changed .
For example you can move VM from Australia Central - first-resource-grp => US Central - second-resource-grp in this case VM will have Australia region but will be attached to the US group

Moving resources across subscriptions:

You can move resource to another Subscription.
If you move vnet you have to move all resources attached to this vnet or you will get an error.

Resource Lock:

Locking resources can help ensure users don't accidently delete or modify resources.
There are two types of locks.
CanNotDelete - authorized users can still read modify a resource, but they can't delete the resource.
ReadOnly - authorized users can read a resource, but they can't delete or update the resource.

Locks can be enabled on Resource group level, resource level and Subscription Level
When you add locks they will enable by hierarchy for example if resource group is locked, then all resources in this resource group will have this lock

How to:

On resource:
>"Locks" => "Locks" => Add

If you want to delete locked resource:
>"Locks" => Delete particular lock 

Moving locked resources:

You can't move resources from group without lock to group WITH lock, you'll get an error.
You can't move resources if on source resource group any locks.

Azure policy:
This tool used to restrict using some resources with particular conditions. For example , be able to create resources ONLY with tags.

How to make:
>Go to "Policy" => "Definitions"

When we have policy we can modify scope level:
>Management group
>Subscription
>Resource Group

Optionallay you can add Exclusions

You can use REMEDIATION:
If you need to create on your resources (for example) specific tag. You can enable "Create remediation task" and add "Add a tag to resource" policy.
In this case you'll get specific tag (which define) on all your resources.
To do this you can use "Create a Managed Identity" in Azure AD or User Assigned managed identity, if you want to remediate this by partircular user.
Identity will get "Contributor" permissions to be able to complete the remediation task.

Not Allowed Resource types:

If you will apply policy wich don't allow to create new Vnet, you will not be able to create new vnet.
This policy will not effect on existing vnet which were created before this policy.

Cost analysis:

In Cost Management + Billing in particular subscription you can monitore your costs.
You can download your costs in file

You can use azure Advisor:
Here you will get some recommendations. For example how to save reduce your costs.

Managememnt groups:

Logical segments for deparment in your company.


==============================================

Monitoring and back up Azure resources

==============================================

Azure monitor = this is tool for monitoring your Azure resources. Collecting logs and analyze this.

In section "Metrics" we can select resource => Check statistics

Alerts:
how to create alert rule:

>In Monitor in "Alerts" section => Create rule
>Select particular resources 
>Create condition "create signal"
>Add action group - this is group of members which will get an alert

Log Analytics Workspace:

This is central solution for all of your logs.
Here we will use Kusto query language.

How to create Analytics Workspace:
>create "Log analytics workspace" 

You can create Log Analytics Workspace in another region then your resources. But you will pay for transfering of data to the Log Analytics Workspace.

How to connect VM to Analytics Workspace:
>In Log Analytics Workspace => In section "Virtual Machines" => select particular VM and click "Connect" (On this machine will installed agent which will send statistics to the workspace)
>Alternatively you can download agent and install manually => in section "Agent management" download agent and install this on your machine => Then enter id and key from workspace (During installation of agent on VM) and in section "Agents configuration"
set "windows event logs" to select which analytics will send from this agent.

Log Analytics Workspace Queries:

In section "Logs" you can use Query for searching particular logs.

In LogManagement we have different logs types:
	>Event
	>Heartbeat
	>Perf
	>Usage

1 Query:

>Event 
This will show all logs by "Event" table

2 Query:
>Event | search "loadvm1"
This query will search for logs in "Event" table for particular VM with name "loadvm1"

3 Query:
>Event | take 5
This is take in no specific order 5 logs

4 Query:
>Event | top 10 by TimeGenerated
This will take 10 logs from (from top of list)

5 Query:
>Event | where EventLevel == 4
This will filter logs by EventLevel = 4 

6 Query:
>Event | where TimeGenerated > ago(5m)
This query will take logs generated 5 minutes ago.

7 Query:
>Event | where TimeGenerated > ago(5m) | project EventLog, Computer

8 Query:
>Perf | where TimeGenerated > ago(5m) | summarize count() by ObjectName, CounterName

9 Query:
>Perf | where TimeGenerated > ago(5m) | summarize avg(CounterValue) by Computer

10 Query:
>Event | where TimeGenerated > ago(1d) | summarize count() by Computer,Source

11 Query:
>Event | where TimeGenerated > ago(1d) | summarize count() by Computer,Source | render barchart
Render barchart will shows you a digram of results

12 Query:
>Event | where TimeGenerated > ago(1d) | summarize makeset(Source) by Computer

Sending Custom logs to Log Ananlytics Workspace:
For Example: Let's start Nginx server on Linux machine
We can find nginx server logs in : /var/logs/nginx/access.log

>We can download this log file and upload this file in section "Custom logs" in Analytics Workspace 
>Connect this VM to analytics workspace

Log Analytics - Alerts:
>In query section write exapmle query "Linuxlog_CL | where RawData contains "93.98.191.196" and click "New alert rule"
In this case you will get alert after avery request from this IP.

Application Insights:

Application Perfomance Management service for web developers.
You can use this tool to monitor your application.
It can help developers detect anomalies in the application.

Requests rates, the response times and failure rates - This is done at the page level.
Exception recorded by your application.
Page views and their load performance as reported from the user's browser.
User and session counts.
Performance counters of the underlying windows or linux machine.
Diagnostic trace logs from your application.

How to make:
>During creating Azure Web App in section "Monitoring" add application insights


Azure Backup feature:
This provides access to data on the VM if something happens to the original VM.
The backup data gets written to a Recovery Services vault.
WARNING - The Recovery Vault need to be in the same location as the VM

Steps during a backup:
>First an extension is installed on the VM - Supported for both Windows and Linux VM's
>The backup tool first takes a snapshot of the data and stores it on the local machine.
>The snapshot of data is then copied to the Recovery Service vault
>When the data is transfered, the snapshot is then removed and a recovery point is then created.

How to enable backup for VM:
>Create Recovery Services vault (or use existing)
>In VM in section "Backup" => Create backup policy 

There are types of snapshots:
>Application-consistent: when you're recovering a VM with an app-consistent snapshot, the VM boots up. There's no data corruption or loss. The apps start in a consistent state.
>File-system consistent: When you're recovering a VM with a file-system consistent snapshot, the VM boots up. There's no data corruption or loss. Apps need to implement their own "fix-up" mechanism to make sure that resotred data is consistent.
>Crash-consistent:Start with the VM boot process followed by a disk check to fix corruption errors. Any in-memory data or write operations that weren't transferred to disk before the crash are lost. Apps implement their own data verification.

To restore files:
>Select snapshot => file recovery => download script and execute then you will be connected to the recovery point.

How to restore VM:
>In VM section "Backup" => Restore VM

To delete Recovery Service vault:
>In Properties => Disable "Soft Delete"
>go to the vault => Backup items => Stop backup and delete bacup data.

MARS agent backup:

MARS - Microsoft Azure Recovery Services agent

Selective backups - Here you can perform selective backups of files and folders.
Backup - Windows Files and Folders. Protect an entire Windows volume. Protect the Windows system state.
Machines - This can be done on your Azure virtual machines or your on-premises machines.
Agent - Here you download and install the Recovery service agent.

How to create:
>Create "Backup and site Recovery". Azure VM and recovery vault should be in the same location.
>In recovery vault in section "Properties" => "Download services Agent"
>Install MARS installer on particular VM

Taking backup:
>Open Azure Backup on VM
>Schedule option => Select items for backup

Recovery Backup:
>Go to another VM (Where we would like to recover backup files)
>Install MARS installer (the same one like on backup VM)
>Choose Recover Data => Choose vault and restore data

Azure Backup reports:
>Insights - You can get insights on aspects such as the number of backups taken and storage consumed.
>Supported for Azure VMs, SAP, HANA in Azure VMs.
>The backup reports data is sent to a Log Analytics workspace.

Azure Site Recovery:
>Used for business continuity and for disaster recovery
>Ensures your apps and workloads are running when there are planned or unplanned outages.

The replication frequency is high, being as low as every 30 seconds for Hyper-V VMs
Hence the RPO is low. And because you can switch over quickly, the RTO is also low.
You can run planned failovers with zero-data loss. Or unplanned failovers with minimal data loss.

RPO - Recovery Point Objective
RTO - Recovery Time Objective

How to make:
>In particular VM go to "Disaster recovery" => Select Another region and other data to recover VM

Failover:

How to test failover:
>In vm settings in "Disaster recovery" => test filover

How to backup File Share:
>Click on fileshare => "backup" => Create backup policy

How to restore file recovery:
>Click on fileshare => "backup" => "File Recovery"


========================================================

Azure PowerShell and Azure CLI

========================================================

You can run PowerShell scripts on:
>Windows
>Linux
>MacOS

PowerShell has the ability to work with .NET objects.
Cmdlets - These are PowerShell commands
Modules - This is a collection of PowerShell commands

Couple of PS commands:
>Get-Service (get all services)
>Get-Service | Where-Object {$_.Status -eq "Running"} (_ - This is current item from output list, this )

How to install Azure PoweShell:
Firstly we have to set execution policy:
>Set-ExecutionPolicy -ExecutionPolicy ByPass
>Install-Module -Name Az -Scope CurrenUser -Repository PSGallery -Force -AllowClobber
>Connect -AzAccount (login to account)

1_script:

$resourceGroup = "exam-grp"
$location = "North Europe"

New-AzResourceGroup -Name $resourceGroup -Location $location


You can alternatively run scripts in Azure CloudShell

Create Vnet script:

$resourceGroup = "exam-grp"
$location = "North Europe"
$network = "exam-network"
$AddressPrefix = "10.1.0.0/16"

New-AzVirtualNetwork -Name $network -ResourceGroupName $resourceGroup `
-Location $location -AddressPrefix $AddressPrefix


Get details from Vnet script:


$resourceGroup = "exam-grp"
$location = "North Europe"
$network = "exam-network"


$virtualNetwork = Get-AzVirtualNetwork -Name $network -ResourceGroupName $resourceGroup
Write-Host $virtualNetwork.Location

Create subnet script:

$resourceGroup = "exam-grp"
$location = "North Europe"
$network = "exam-network"
$subnetAddressPrefix = "10.1.0.0/24"

$virtualNetwork = Get-AzVirtualNetwork -Name $network -ResourceGroupName $resourceGroup
Add-AzVirtualNetworkSubnetConfig -Name $subnetName -VirtualNetwork $network -AddressPrefix $subnetAddressPrefix
$virtualNetwork | Set-AzVirtualNetwork

Script to new Vnet with subnet:

$resourceGroup = "exam-grp"
$location = "North Europe"
$network = "exam-network"
$subnetAddressPrefix = "10.1.0.0/24"
$AddressPrefix = "10.1.0.0/16"

$subnet = Add-AzVirtualNetworkSubnetConfig -Name $subnetName -VirtualNetwork $network -AddressPrefix $subnetAddressPrefix
New-AzVirtualNetwork -Name $network -ResourceGroupName $resourceGroup -Location $location -AddressPrefix $AddressPrefix -Subnet $subnet

Create a network interface:

$resourceGroup = "exam-grp"
$location = "North Europe"
$network = "exam-network"
$subnetName = "SubnetA"
$networkInterfaceName = "app-interface"

$virtualNetwork = Get-AzVirtualNetwork -Name $network -ResourceGroupName $resourceGroup
$subnet = Get-AzVirtualNetworkSubnetConfig -VirtualNetwork $virtualNetwork -Name $subnetName
New-AzNetworkInterface -Name $networkInterfaceName ResourceGroupName $resourceGroup -Location $location -SubnetId $subnet.Id

Create public IP address:

$resourceGroup = "exam-grp"
$location = "North Europe"
$publicAddressName = "app-public-ip"

New-AzPublicIpAddress -Name $publicIPAddressName -ResourceGroupName $resourceGroup -Location $location -AllocationMethod Dynamic

Create Network Security Group:

$resourceGroup = "exam-grp"
$location = "North Europe"
$networkSecurityGroupName = "app-nsg"

$nsgrule1=New-AzNetworkSecurityRuleConfig -Name Allow-RDP -Access Access -Protocol Tcp -Direction Inbound -Priority 120 -SourceAddressPrefix Internet -SourcePortRange * -DestinationAddressPrefix 10.1.0.0/24 -DestinationPortRange 3389
$nsgrule1=New-AzNetworkSecurityRuleConfig -Name Allow-RDP -Access Access -Protocol Tcp -Direction Inbound -Priority 130 -SourceAddressPrefix Internet -SourcePortRange * -DestinationAddressPrefix 10.1.0.0/24 -DestinationPortRange 80

New-AzNetworkSecurityGroup -Name $networkSecurityGroupName -ResourceGroupName $resourceGroup -Location $location -SecurityRules $nsgrule1,$nsgrule2

Create VM script:

$resourceGroup = "exam-grp"
$location = "North Europe"
$networkSecurityGroupName = "app-nsg"
$vmName = "appvm"
$vmSize = "Standard_DS2_v2"
$vmImage = "Win2019Datacenter"
$nsgName = "app-nsg"
$vmPublicIP = "app-public-ip"
$virtualNetworkName = "exam-network"
$subnetName = "SubnetA"
$dataDiskName = "my-disk"

Get-AzVMSize -Location "North Europe" (run this to check available sizes in Europe Location)

New-AzVM -ResourceGroupName $resourceGroup -Location $location -Name $vmName -virtualNetworkName $virtualNetworkName -Subnet $subnetName -Image $vmImage -SecurityGroup $nsgName -PublicIpAddressName $vmPublicIP -Credential (Get-Credential)


# If you want to attach a data disk to VM :

$dataDiskConfig = New-AzDiskConfig -Location $location -CreateOption Empty -DiskSizeGB 16 -SkuName "Standard_LRS"
$dataDisk = New-AzDisk -ResourceGroupName $resourceGroup -DiskName $dataDiskName -Disk $dataDiskConfig
$vm = Get-AzVM -ResourceGroupName $resourceGroup -Name $vmName
$vm = Add-AzVMDataDisk -VM $vm -Name $dataDiskName -CreateOption Attach -ManagedDiskId $dataDisk.Id -Lun 0

Update-AzVM -ResourceGroupName $resourceGroup -VM $vm

Create Availability Set script:

$resourceGroup = "exam-grp"
$location = "North Europe"
$availabilitySetName = "app-set"

New-AzAvailabilitySet -ResourceGroupName $resourceGroup -Location $location -Name $availabilitySetName -Sku Aligned `
-PlatformFaultDomainCount 3 -PlatfromUpdateDomainCount 5

To attach VM to this availability set use script to create VM and add -AvailabilitySetName $availabilitySetName

create Storage Account script:

$resourceGroup = "exam-grp"
$location = "North Europe"
$storageAccountName = "appstore228332"

New-AzStorageAccount -ResourceGroupName $resourceGroup -Name $storageAccountName -Location $location -SkuName Standard_GRS -Kind StorageV2

Script create Azure Web App:

$resourceGroup = "exam-grp"
$location = "North Europe"
$appServicePlanName = "app-plan"
$appName = "webapp788788"

#First we need to create the App Service Plan

New-AzAppServicePlan -Name $appServicePlanName -ResourceGroupName $resourceGroup -Location $location -Tier Free
 
#Then we create the Azure Web App

New-AzWebApp -Name $appName -ResourceGroupName $resourceGroup -Location $location -AppServicePlan $appServicePlanName

How to deploy Web App from github (Script):

$resourceGroup = "exam-grp"
$location = "North Europe"
$githubURL = "your git hub url repo"

$PropertiesObject = @{
	repoUrl = $githubURL;
	branch = "master";
	isManualIntegration = "true";
}

Set-AzResource -Properties $PropertiesObject -ResourceGroupName $resourceGroupName `
-ResourceType Mircrosoft.Web/sites/sourcecontrols -ResourceName $appname/web -ApiVersion 2015-08-01 -Force

Create deployement slots (script):

$resourceGroup = "exam-grp"
$location = "North Europe"
$appServicePlanName = "app-plan"
$appName = "webapp788788"

#First we need to create the App Service Plan

New-AzAppServicePlan -Name $appServicePlanName -ResourceGroupName $resourceGroup -Location $location -Tier Standard (or Higher to use slots)

#Then we create a new deployment slot

New-AzWebAppSlot -Name $appName -ResourceGroupName $resourceGroup -Slot staging

#Then we deploy a newer version

$PropertiesObject = @{
	repoUrl = $githubURL;
	branch = "master";
	isManualIntegration = "true";
}

Set-AzResource -Properties $PropertiesObject -ResourceGroupName $resourceGroupName `
-ResourceType Mircrosoft.Web/sites/slots/sourcecontrols -ResourceName $appname/staging/web -ApiVersion 2015-08-01 -Force

#And then we swap the slots
Switch-AzWebAppSlot -Name $appname -ResourceGroupName $resourceGroup -SourceSlotName staging -DestinationSlotName production

Create VM scale set:

$resourceGroup = "exam-grp"
$location = "North Europe"
$networkSecurityGroupName = "app-nsg"
$scaleSetName= "appvm-scale-set"
$vmSize = "Standard_DS2_v2"
$vmImage = "Win2019Datacenter"
$nsgName = "app-nsg"
$vmPublicIP = "app-public-ip"
$virtualNetworkName = "exam-network"
$subnetName = "SubnetA"
$dataDiskName = "my-disk"

New-AzVMss -ResourceGroupName $resourceGroup -Location $location -VMScaleSetName $scaleSetName -virtualNetworkName $virtualNetworkName '
-Subnet $subnetName -Image $vmImage -UpgradePolicyMode "Automatic" -SecurityGroup $nsgName -PublicIpAddressName $vmPublicIP -Credential (Get-Credential)

Azure CLI:

To install download installer from Microsoft Page
>az login (to login)

Create resource group Azure CLI:

>az group create --name "cli-grp" --location "North Europe"

How to create a Vnet Azure CLI:

>az network vnet create --name cli-network --resource-group cli-grp --subnet-name SubnetA --address-prefixes 10.0.0.0/16

#To get details of an existing vnet
>az network vnet show -g cli-grp -n cli-network

#get list of networks
>az network vnet list

#create subnet
>az network vnet subnete create --name SubnetB --address-prefixes 10.0.1.0/24 --resource-group cli-grp

#Create VM
>az vm create --resource-group cli-grp --name appvm --image Win2019Datacenter --public-ip-sku Standard --admin-username demouser

#list vm
>az vm list-sizes --location "North Europe"

Attach data disk Azure CLI:

>az disk create --name data-disk --resource-group cli-grp --location "North Europe" --size-gb 16 (this command will create disk)
>$id=az disk show --name data-disk --resource-group cli-grp --query id
>az vm disk attach --vm-name appvm --lun 0 --resource-group cli-grp --ids $id

Azure storage account Azure CLI:

>az storage account create--name appstore465665 --resource-group cli-grp --kind StorageV2 --sku Standard_LRS 

Azure Web App Azure CLI:

>az appservice plan create --name cliplan1000 --resource-group cli-grp --sku F1
>az webapp create --name webapp9088776 --plan cliplan1000 --resource-group cli-grp

Azure Scale set Azure CLI:

>az vmss create --name app-set --resource-group cli-grp --admin-username demouser --image Win2019Datacenter --vm-sku "Standard_DS2_v2"

Azure Kubernetes Azure CLI:

#Create the Kubernetes cluster
>az aks create --resource-group app-grp --name appcluster --node-counter 1 --enable-addons monitoring --generate-ssh-keys

#Only if you don't have the kubectl tools. This is already available 
>az aks install-cli

#Get the credential of the cluster
>az aks get-credentials --resource-group app-grp --name appcluster

#Get the status of the Kubernetes nodes
>kubectl get nodes

#Apply the application configuration files
>kubectl apply -f deployment.yml
>kubectl apply -f service.yml

#Get the external IP for the service
>kubectl get service app-service

Cloud Init Azure CLI:

>az vm create --resource-group app-grp --name linuxvm --image Canonical:UbuntuServer:18.04-LTS:latest --custom-data config.txt --admin-username demousr --admin-password "AzurePassword@123"